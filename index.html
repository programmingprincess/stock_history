<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Stock History</title>
    <script src="Chart.min.js"></script>
    <script src="utils.js"></script>
    <script src='config.js'></script>

    <link href="style.css" rel="stylesheet" type="text/css">
    <script type="text/javascript" src="symbolCompanyMapping.json"></script>

</head>
<body>
<h1 class = "title">Stock History </h1>
<h3>1. Find relevant news: </h3>
Stock Symbol: <input type="text" id="stockSymbol" value="AAPL">
<!-- Date: <input type="text" id="myDate" value="YYYY-MM-DD"> -->
<button onclick = "updateTreeSelection()"> Find results</button>
<!-- 

<h3>1. Select a tree: </h3>
<select id="tree-dropdown" onchange="updateTreeSelection(this)">
  <option value="msft" id="tree0">Tree 0</option>
  <option value="aapl" id="tree1">Tree 1</option>
  <option value="crm" id="tree2">Tree 2</option>
  <option value="tree3" id="tree2">Tree 3</option>
</select> -->

<div class = "stock_chart"> 
  <div class = "canvas_container">
    <canvas id="canvas"></canvas>
  </div>
</div>
<!--   <br>
  <br>
  <button id="randomizeData">Randomize Data</button>
  <button id="addDataset">Add Dataset</button>
  <button id="removeDataset">Remove Dataset</button>
  <button id="addData">Add Data</button>
  <button id="removeData">Remove Data</button> -->
<!-- 
<h3>1. Find relevant news: </h3>
Company: <input type="text" id="myText" value="Company name">
Date: <input type="text" id="myDate" value="YYYY-MM-DD">
<button onclick = "callNewsAPI()"> Find results</button> -->



<div id="searchInfo" class="boldClass">Table Below Populates After A Date Is Clicked.</div>
<div class="col-md-6">
  <table id="firstTabOverall">
      <thead>
          <th>Source</th>
          <th>Title</th>
          <th>Description</th>
      </thead>
      <tbody>
        <tr></tr>
      </tbody>
  </table>
</div>

</body>


<script type="text/javascript" src="main.js"></script>
<script>
var getJSON = function(url, callback) {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', url, true);
    xhr.responseType = 'json';
    xhr.onload = function() {
      var status = xhr.status;
      if (status === 200) {
        callback(null, xhr.response);
      } else {
        callback(status, xhr.response);
      }
    };
    xhr.send();
};
//api keys 
// 1. open: "152.4100"
// 2. high: "163.7100"
// 3. low: "152.0000"
// 4. close: "162.0100"
// 5. adjusted close: "162.0100"
// 6. volume: "96388312"
// 7. dividend amount: "0.0000"
// 8. split coefficient: "1.0000"

var dow="";
var dates = [];

getJSON('https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol=SPY&apikey='+config.stocks_api_key,
function(err, data) {
  if (err !== null) {
    console.log('Something went wrong while parsing your JSON API:' + err);
  } else {
    series=data["Time Series (Daily)"];
    dates = [];
    var prices= [];

    for (var time in series) {
      dates.push(time);
      prices.push(series[time]["4. close"]);
    }

    dates= dates.reverse();
    prices=prices.reverse();

    dates=dates.slice(70,100);
    prices=prices.slice(70,100);

    graphme(dates, prices);
    dow=prices;
  }
    
});



updateTreeSelection = function() {
    // tree_id=dropdown.value;
    // idx=tree_id.substring(4);
    // idx=parseInt(idx);
    

    var url = 'https://www.alphavantage.co/query?function=TIME_SERIES_DAILY_ADJUSTED&symbol='+document.getElementById("stockSymbol").value+'&apikey='+config.stocks_api_key
    getJSON(url,
    function(err, data) {
      if (err !== null) {
        console.log('Something went wrong while parsing your JSON API:' + err);
      } else {
        series=data["Time Series (Daily)"];
        dates = [];
        var prices= [];

        for (var time in series) {
          dates.push(time);
          prices.push(series[time]["4. close"]);
        }

        dates= dates.reverse();
        prices=prices.reverse();
        
        dates=dates.slice(70,100);
        prices=prices.slice(70,100);

        graphme(dates, dow, prices);
      }
        
    });
    // document.getElementById("printme").innerHTML = "LOl" + idx;
    // callNewsAPI();
}


callNewsAPI = function(symbol, date) {
  var set1 = new Set(); 
  set1.add("Coinspeaker.com");
  set1.add("Seekingalpha.com");
  set1.add("Nasdaq.com");
  set1.add("Businesswire.com");
  set1.add("Marketwatch.com");
  set1.add("Bloomberg");
  set1.add("Indianexpress.com");
  set1.add("Forbes.com");
  set1.add("Ndtv.com");
  set1.add("Autoblog.comhttps");
  set1.add("Japantimes.co.jp");
  set1.add("Foxbusiness.com");
  set1.add("Reuters");
  set1.add("Business Insider");
  set1.add("Investing.com");
  set1.add("Yahoo.com");


    // searchTerm = document.getElementById("myText").value;
    // date = document.getElementById("myDate").value;
    // searchTerm = dropdown.value;
  var companyName = ""
  if(symbol=="MIMIC"){
    companyName = "Stock Market";
  }
  else{  
    companyName = mappings[symbol];}


  var url = 'http://newsapi.org/v2/everything?' +
            'q='+companyName+'&' +
            // 'to=2020-01-18&' +
            // 'to=2020-01-18&' +
            'from='+date+'&' +
            'to='+date+'&' +
            'sortBy=popularity&' +
            'apiKey='+config.news_api_key;
              
  var req = new Request(url);
  var res = ""
  fetch(req)
      .then(function(response) {
        return response.json();
      }).then(response=>{
        // debugger
        res = response.articles[0].description;
        // debugger
        console.log(res);
        // document.getElementById("printme").innerHTML = res;
        var table = document.getElementById("firstTabOverall");
        var childNodes = document.getElementById("firstTabOverall").childNodes[3];
        var new_tbody = document.createElement('tbody');
        // helper function        
        function addCell(tr, text) {
                var td = tr.insertCell();
                td.innerHTML = text;
                return td;
            }

        
        // insert data
        // if (response.articles.length>7){
        //   response.articles = response.articles.slice(0,6);
        // }
        response.articles.forEach(function (article) {
            var tit = article.title;
            var yooareel = tit.link(article.url);
            if(set1.has(article.source.name)){
              var row = new_tbody.insertRow();
              addCell(row, article.source.name);
              addCell(row, yooareel);
              addCell(row, article.description);
            //   set1.add(article.source.name);
             }

        });
        childNodes.parentNode.replaceChild(new_tbody, childNodes)
      })
}

</script>

</html>
